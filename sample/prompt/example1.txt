-- Calculate ROE of VIC, VRE and VHM in first 2 quarter of 2024

-- Get Net income value
WITH net_income AS (
    SELECT nbfr.data AS net_income, nbfr.stock_code as stock_code, nbfr.quarter as quarter, nbfr.year as year
    FROM non_bank_financial_report nbfr
    JOIN map_category_code_non_bank mc 
      ON nbfr.category_code = mc.category_code
    WHERE nbfr.stock_code in ('VIC', 'VRE', 'VHM')
      AND nbfr.year = 2024
      AND nbfr.quarter in (1,2)
      AND mc.en_caption = 'Profit after Corporate Income Tax'
),

-- Get equity value
equity AS (
    SELECT nbfr.data AS equity, nbfr.stock_code as stock_code, nbfr.quarter as quarter, nbfr.year as year
    FROM non_bank_financial_report nbfr
    JOIN map_category_code_non_bank mc 
      ON nbfr.category_code = mc.category_code
    WHERE nbfr.stock_code in ('VIC', 'VRE', 'VHM')
      AND nbfr.year = 2024
      AND nbfr.quarter in (1,2)
      AND mc.en_caption = 'Revenue from Sales of Goods and Services'
)
-- Select detail information 
SELECT 
	net_income.stock_code,
	net_income.year,
	net_income.quarter,
	net_income.net_income,
    (net_income.net_income / equity.equity) AS ROE
    	
FROM net_income
JOIN equity 
ON net_income.stock_code = equity.stock_code
AND net_income.quarter = equity.quarter 
AND net_income.year = equity.year;
-- Join on both quarter and year to avoid duplication