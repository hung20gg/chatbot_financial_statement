-- 1. Get all companies owned by MSN 

SELECT stock_code as company, invest_on 
FROM sub_and_shareholder 
WHERE stock_code = 'MSN';

-- 2. Get all the shareholder of TCB 

SELECT stock_code as shareholder, invest_on
FROM sub_and_shareholder 
WHERE invest_on = 'TCB';

-- 3. Get all the real-estate companies own by VIC 

SELECT sns.stock_code as company, sns.invest_on as invest_on , ci.industry as industry
FROM company_info ci
join sub_and_shareholder sns  on sns.invest_on  = ci.stock_code 

WHERE sns.stock_code = 'VIC'
AND industry = 'Real Estate';

-- 4. Get all Food and Beverage companies

SELECT stock_code, industry FROM company_info
WHERE industry = 'Food and Beverage';

-- 5. What is the Return on Equity (ROE) for Masan Group (MSN) in Q2 2023?  Provide the ROE as a percentage.

SELECT 
    stock_code,
    ROUND(data::numeric  * 100, 2) AS ROE_percentage
FROM 
    financial_ratio
WHERE 
    ratio_code = 'ROE' -- assuming 'ROE' is the ratio code for Return on Equity
    AND year = 2023
    AND quarter = 2
    AND stock_code = 'MSN';

-- 6. What were the current ratio and quick ratio for Vinamilk (VHM) and Masan Group (MSN) in 2023?

with value as (SELECT 
    stock_code,
    year,
    quarter,
    ratio_code,
    ROUND(data::numeric  * 100, 2) AS data 
FROM 
    financial_ratio
WHERE 
    ratio_code in ('CashR', 'CurrentR')
    AND year = 2023
    AND quarter = 2
    AND stock_code = 'MSN')
    
 select value.stock_code as stock_code,
 		value.year as year,
 		value.quarter as quarter,
 		value.data as data,
 		mccr.ratio_name as ratio_name
from value
join map_category_code_ratio mccr 
on value.ratio_code = mccr.ratio_code;

-- 7. Get the total asset of all child company of viettel
-- Step 1: Get all companies owned by Viettel
WITH viettel_subsidiaries AS (
    SELECT invest_on AS subsidiary
    FROM sub_and_shareholder
    WHERE stock_code = 'Viettel'
),

-- Step 2: Get total assets of these subsidiaries using BS_270 as the code for total assets
total_assets AS (
    SELECT nf.stock_code, nf.data AS total_asset, nf.year as year
    FROM viettel_subsidiaries vs
    JOIN non_bank_financial_report nf ON vs.subsidiary = nf.stock_code
    WHERE nf.quarter = 0 AND nf.category_code = 'BS_270'
    
    UNION ALL
    
    SELECT bf.stock_code, bf.data AS total_asset, bf.year as year
    FROM viettel_subsidiaries vs
    JOIN bank_financial_report bf ON vs.subsidiary = bf.stock_code
    WHERE bf.quarter = 0 AND bf.category_code = 'BS_300'
    
    UNION ALL
    
    SELECT sf.stock_code, sf.data AS total_asset, sf.year as year
    FROM viettel_subsidiaries vs
    JOIN securities_financial_report sf ON vs.subsidiary = sf.stock_code
    WHERE sf.quarter = 0 AND sf.category_code = 'BS_270'
)

-- Step 3: Calculate the total asset of all subsidiaries of Viettel
select * from total_assets
order by year desc
